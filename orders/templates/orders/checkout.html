{% extends 'base.html' %}
{% load static %}

{% block title %}Checkout | Hop & Barley{% endblock %}

{% block content %}
<main class="checkout-page-wrapper">
    <div class="checkout-container">
        <h1 class="checkout-title">Order Details</h1>

        <form method="post" id="checkout-form">
            {% csrf_token %}
            <!-- Shipping Information -->
            <section class="checkout-section">
                <h2 class="checkout-section__title">Shipping information</h2>
                <div class="checkout-form-group">
                    <label for="shipping_address">Shipping address</label>
                    {% if user.city or user.address %}
                    <div class="address-autofill">
                        <button type="button" id="autofill-address" class="button button--secondary button--small">
                            <i class="fas fa-map-marker-alt"></i> Use my saved address
                        </button>
                    </div>
                    {% endif %}
                    <textarea id="shipping_address" name="shipping_address" 
                              class="Textarea" placeholder="Enter your full shipping address" 
                              rows="3" required></textarea>
                </div>
            </section>

            <!-- Payment Method -->
            <section class="checkout-section">
                <h2 class="checkout-section__title">Payment Method</h2>
                <div class="payment-methods">
                    <div class="payment-option">
                        <input type="radio" id="payment_card" name="payment_method" value="card" checked>
                        <label for="payment_card" class="payment-label">
                            <div>
                                <i class="fas fa-credit-card"></i>
                                <span>Credit/Debit Card</span>
                            </div>
                            <small>Online payment</small>
                        </label>
                    </div>
                    <div class="payment-option">
                        <input type="radio" id="payment_cod" name="payment_method" value="cash_on_delivery">
                        <label for="payment_cod" class="payment-label">
                            <div>
                                <i class="fas fa-money-bill-wave"></i>
                                <span>Cash on Delivery</span>
                            </div>
                            <small>Pay when received</small>
                        </label>
                    </div>
                </div>

                <!-- Card Payment Form (shown when card is selected) -->
                <div id="card-payment-form" class="card-payment-form">
                    <h3 class="card-form-title">Card Information</h3>
                    <div class="card-form-grid">
                        <div class="form-group">
                            <label for="card_number">Card Number</label>
                            <input type="text" id="card_number" name="card_number" 
                                   placeholder="1234 5678 9012 3456" maxlength="19" 
                                   pattern="[0-9\s]{13,19}">
                        </div>
                        <div class="form-group">
                            <label for="card_holder">Cardholder Name</label>
                            <input type="text" id="card_holder" name="card_holder" 
                                   placeholder="John Doe" maxlength="50">
                        </div>
                        <div class="form-group">
                            <label for="expiry_date">Expiry Date</label>
                            <input type="text" id="expiry_date" name="expiry_date" 
                                   placeholder="MM/YY" maxlength="5" pattern="[0-9]{2}/[0-9]{2}">
                            <div class="error-message" id="expiry_error">Card has expired</div>
                        </div>
                        <div class="form-group">
                            <label for="cvv">CVV</label>
                            <input type="text" id="cvv" name="cvv" 
                                   placeholder="123" maxlength="4" pattern="[0-9]{3,4}">
                        </div>
                    </div>
                    <div class="payment-note">
                        <i class="fas fa-lock"></i>
                        <span>This is a demo payment form. No real payment will be processed.</span>
                    </div>
                </div>

                <!-- Cash Payment Info (shown when cash is selected) -->
                <div id="cash-payment-info" class="cash-payment-info" style="display: none;">
                    <div class="payment-info-box">
                        <i class="fas fa-info-circle"></i>
                        <div>
                            <h4>Cash Payment</h4>
                            <p>You will pay when you receive your order. The order will be marked as "Pending" until payment is received.</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Order Summary -->
            <section class="checkout-summary">
                <h2 class="checkout-section__title">Order Summary</h2>
                <div class="summary-details">
                    {% for item in cart %}
                    <div class="summary-item">
                        <span>{{ item.name }} Ã— {{ item.quantity }}</span>
                        <span>{{ item.total_price }}</span>
                    </div>
                    {% endfor %}
                    
                    <hr>
                    <div class="summary-total">
                        <p>Total</p>
                        <p>{{ cart.get_total_price }}</p>
                    </div>
                    
                    <button type="submit" class="button button--primary button--pay">
                        Confirm Order
                    </button>
                    
                    <a href="{% url 'orders:cart_detail' %}" class="button button--secondary">
                        Back to Cart
                    </a>
                </div>
            </section>
        </form>
    </div>
</main>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Address autofill functionality
    const autofillButton = document.getElementById('autofill-address');
    const addressTextarea = document.getElementById('shipping_address');
    
    if (autofillButton && addressTextarea) {
        autofillButton.addEventListener('click', function() {
            // Get user's saved address data
            const userCity = '{{ user.city|default:"" }}';
            const userAddress = '{{ user.address|default:"" }}';
            
            // Combine city and address
            let fullAddress = '';
            if (userAddress) {
                fullAddress = userAddress;
            }
            if (userCity) {
                if (fullAddress) {
                    fullAddress += ', ' + userCity;
                } else {
                    fullAddress = userCity;
                }
            }
            
            // Fill the textarea
            if (fullAddress) {
                addressTextarea.value = fullAddress;
                // Add visual feedback
                autofillButton.innerHTML = '<i class="fas fa-check"></i> Address filled!';
                autofillButton.classList.add('button--success');
                setTimeout(() => {
                    autofillButton.innerHTML = '<i class="fas fa-map-marker-alt"></i> Use my saved address';
                    autofillButton.classList.remove('button--success');
                }, 2000);
            }
        });
    }

    // Payment method switching
    const paymentMethods = document.querySelectorAll('input[name="payment_method"]');
    const cardForm = document.getElementById('card-payment-form');
    const cashInfo = document.getElementById('cash-payment-info');
    
    function togglePaymentForms() {
        const selectedMethod = document.querySelector('input[name="payment_method"]:checked').value;
        
        if (selectedMethod === 'card') {
            cardForm.style.display = 'block';
            cashInfo.style.display = 'none';
        } else {
            cardForm.style.display = 'none';
            cashInfo.style.display = 'block';
        }
    }
    
    // Add event listeners to payment method radio buttons
    paymentMethods.forEach(method => {
        method.addEventListener('change', togglePaymentForms);
    });
    
    // Initialize form visibility
    togglePaymentForms();

    // Card number formatting
    const cardNumberInput = document.getElementById('card_number');
    if (cardNumberInput) {
        cardNumberInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\s/g, '').replace(/[^0-9]/gi, '');
            let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
            if (formattedValue.length <= 19) {
                e.target.value = formattedValue;
            }
        });
    }

    // Expiry date formatting and validation
    const expiryInput = document.getElementById('expiry_date');
    const expiryError = document.getElementById('expiry_error');
    
    if (expiryInput) {
        expiryInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length >= 2) {
                value = value.substring(0, 2) + '/' + value.substring(2, 4);
            }
            e.target.value = value;
            
            // Clear error state when user starts typing
            e.target.classList.remove('error');
            if (expiryError) {
                expiryError.style.display = 'none';
            }
        });
        
        // Validate on blur
        expiryInput.addEventListener('blur', function(e) {
            const value = e.target.value.trim();
            if (value && value.length === 5) {
                if (!validateCardExpiry(value)) {
                    e.target.classList.add('error');
                    if (expiryError) {
                        expiryError.style.display = 'block';
                    }
                } else {
                    e.target.classList.remove('error');
                    if (expiryError) {
                        expiryError.style.display = 'none';
                    }
                }
            }
        });
    }

    // CVV formatting (numbers only)
    const cvvInput = document.getElementById('cvv');
    if (cvvInput) {
        cvvInput.addEventListener('input', function(e) {
            e.target.value = e.target.value.replace(/[^0-9]/g, '');
        });
    }

    function validateCardExpiry(expiryDate) {
        try {
            if (!expiryDate || expiryDate.length !== 5 || expiryDate[2] !== '/') {
                return false;
            }
            
            const [month, year] = expiryDate.split('/');
            
            if (!/^\d{2}$/.test(month) || !/^\d{2}$/.test(year)) {
                return false;
            }
            
            const monthNum = parseInt(month);
            const yearNum = parseInt('20' + year);
            
            if (monthNum < 1 || monthNum > 12) {
                return false;
            }
            
            const currentDate = new Date();
            const currentYear = currentDate.getFullYear();
            const currentMonth = currentDate.getMonth() + 1;
            
            if (yearNum < currentYear || (yearNum === currentYear && monthNum < currentMonth)) {
                return false;
            }
            
            return true;
        } catch (error) {
            return false;
        }
    }

    const checkoutForm = document.getElementById('checkout-form');
    if (checkoutForm) {
        checkoutForm.addEventListener('submit', function(e) {
            const selectedMethod = document.querySelector('input[name="payment_method"]:checked').value;
            
            if (selectedMethod === 'card') {
                const cardNumber = document.getElementById('card_number').value;
                const cardHolder = document.getElementById('card_holder').value;
                const expiryDate = document.getElementById('expiry_date').value;
                const cvv = document.getElementById('cvv').value;
                
                if (!cardNumber || !cardHolder || !expiryDate || !cvv) {
                    e.preventDefault();
                    alert('{{ settings.ORDER_MESSAGES.CARD_DETAILS_REQUIRED }}');
                    return;
                }
                
                const cleanCardNumber = cardNumber.replace(/\s/g, '');
                if (cleanCardNumber.length < 13 || cleanCardNumber.length > 19) {
                    e.preventDefault();
                    alert('{{ settings.ORDER_MESSAGES.CARD_NUMBER_LENGTH }}');
                    return;
                }
                
                if (!validateCardExpiry(expiryDate)) {
                    e.preventDefault();
                    alert('{{ settings.ORDER_MESSAGES.CARD_EXPIRED }}');
                    return;
                }
                
                if (!/^\d{2}\/\d{2}$/.test(expiryDate)) {
                    e.preventDefault();
                    alert('{{ settings.ORDER_MESSAGES.CARD_INVALID_FORMAT }}');
                    return;
                }
                
                if (cvv.length < 3 || cvv.length > 4) {
                    e.preventDefault();
                    alert('{{ settings.ORDER_MESSAGES.CARD_CVV_INVALID }}');
                    return;
                }
            }
        });
    }
});
</script>
{% endblock %}